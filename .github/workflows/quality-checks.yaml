---
name: "Quality Checks"
on:
  pull_request:
  push:
    branches:
      - main
jobs:
  check-code-quality:
    name: "Check Code Quality"
    runs-on: ubuntu-latest
    steps:
      - run: echo "ğŸš€ Job automatically triggered by ${{ github.event_name }}"
      - run: echo "ğŸ§ Job running on ${{ runner.os }} server"
      - run: echo "ğŸ™ Using ${{ github.ref }} branch from ${{ github.repository }} repository"

      - name: "Checkout code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: echo "ğŸ™ ${{ github.repository }} repository was cloned to the runner."

      - name: "Prepare Java runtime"
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: "Cache Clojure Dependencies"
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: clojure-deps-${{ hashFiles('**/deps.edn') }}
          restore-keys: clojure-deps-

      - name: "Install tools"
        uses: DeLaGuardo/setup-clojure@12.5
        with:
          cli: 1.11.3.1463 # Clojure CLI
          cljstyle: 0.16.626
          clj-kondo: 2024.08.29

      - name: "Kaocha test runner"
        run: clojure -X:test/env:test/run

      - name: "Lint Clojure"
        run: clj-kondo --lint deps.edn --config '{:output {:pattern "::{{level}} file={{filename}},line={{row}},col={{col}}::{{message}}"}}'

      - name: "Check Clojure Style"
        run: cljstyle check --report

      - run: echo "ğŸ¨ style and format of Clojure code checked"

      - run: echo "ğŸ Job status is ${{ job.status }}."
